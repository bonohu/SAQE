
    <!DOCTYPE html>
    <style>
    
        .axis .domain {
            display: none;
        }
    
        .tick text {
            font-size: 14px
        }
        body > svg > g > g:nth-child(4) > g:nth-child(1) > rect {
            fill: #777777;
        }
    
    </style>
    <svg width="960" height="850"></svg>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-color@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-interpolate@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-scale-chromatic@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-dsv@3"></script>
    <script>
    
        var svg = d3.select("svg"),
            margin = {top: 20, right: 300, bottom: 70, left: 40},
            width = +svg.attr("width") - margin.left - margin.right,
            height = +svg.attr("height") - margin.top - margin.bottom,
            g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    
        var x = d3.scaleBand()
            .rangeRound([0, width])
            .paddingInner(0.05)
            .align(0.1);
    
        var y = d3.scaleLinear()
            .rangeRound([height, 0]);
    
        var z = d3.scaleOrdinal()
            .range(d3.schemeCategory20b.concat(new Array(50).fill("#888888")));
        

        var S = "library,Peptacetobacter hiranonis,Blautia sp.,Phocaeicola coprocola,Fusobacteriaceae bacterium DJF_B254,Phocaeicola plebeius,Fusobacterium nucleatum,Clostridioides difficile,Bacteroides ndongoniae,Blautia caecimuris,Bacteroides mediterraneensis,Ruminococcus sp. WAL 17306,Blautia hansenii,[Ruminococcus] gnavus,Paraclostridium bifermentans,Bacteroides uniformis,Phocaeicola vulgatus,Blautia sp. YHC-4,Clostridium sp. AT4,Fusobacterium necrophorum,Bacteroides stercoris,Glucerabacter canisensis,Fusobacterium necrogenes,Sutterella sp.,Helicobacter canis,Selenomonas sp. oral taxon 479,Sutterella massiliensis,Dialister pneumosintes,Collinsella aerofaciens,Bacteroides fragilis,Terrisporobacter petrolearius,Selenomonas noxia,Megamonas sp.,Collinsella intestinalis,Bacteroides cellulosilyticus,Megamonas hypermegale,Butyrivibrio fibrisolvens,Prevotella sp. oral taxon 313,Veillonella dispar,Prevotella intermedia,Paenibacillus amylolyticus,others\nsample01,7.13,6.45,4.89,3.46,2.65,2.49,2.45,1.82,1.76,1.57,1.53,1.39,1.31,1.15,1.05,0.97,0.95,0.9,0.82,0.74,0.73,0.68,0.67,0.6,0.59,0.57,0.57,0.54,0.54,0.54,0.52,0.51,0.5,0.49,0.49,0.42,0.39,0.39,0.35,0.35,44.079999999999984\nsample02,24.78,12.98,0.01,0.04,0,0.02,8.18,0,3.54,0,0.06,4.72,2.09,3.22,0,0.01,3.91,0,0.01,0,0.11,0,0,0,0,0,0,0.72,0,2.09,0,0,0.61,0,0,0.81,0,0,0,0,32.08999999999999\n"

        var G = "library,Bacteroides,Blautia,Phocaeicola,Peptacetobacter,Fusobacterium,Clostridium,Clostridioides,Selenomonas,Prevotella,Ruminococcus,Bacillus,Collinsella,Mediterraneibacter,Sutterella,Paraclostridium,Veillonella,Megamonas,Staphylococcus,Dialister,Helicobacter,Glucerabacter,Paenibacillus,Terrisporobacter,Peptostreptococcus,Megasphaera,Butyrivibrio,Porphyromonas,Halobacillus,Lachnoclostridium,Eubacterium,Lacrimispora,Faecalimonas,Pectinatus,Lachnospira,Brevibacillus,Paeniclostridium,Lactiplantibacillus,Lysinibacillus,Enterococcus,Exiguobacterium,others\nsample01,12.95,12.68,8.92,7.2,5.95,3.49,2.81,2.28,2.21,2.08,2.07,2.0,1.9,1.52,1.31,1.25,1.19,0.98,0.9,0.74,0.73,0.72,0.64,0.48,0.45,0.45,0.41,0.37,0.37,0.31,0.29,0.26,0.24,0.22,0.21,0.18,0.18,0.16,0.16,0.15,18.589999999999947\nsample02,0.03,29.19,0.01,24.97,0.04,5.74,8.99,0.01,0.01,0.56,0.49,2.73,2.61,0,3.63,0.01,0,0.27,0.01,0,0.11,0.1,2.38,1.26,0,0.87,0,0.01,0.51,0.34,0.32,0.51,0,0.04,0.03,0.49,0,0.02,0.05,0,13.659999999999982\n"

        var F = "library,Bacteroidaceae,Lachnospiraceae,Peptostreptococcaceae,Fusobacteriaceae,Selenomonadaceae,Clostridiaceae,Bacillaceae,Veillonellaceae,Oscillospiraceae,Prevotellaceae,Coriobacteriaceae,Sutterellaceae,Staphylococcaceae,Paenibacillaceae,Lactobacillaceae,Helicobacteraceae,Porphyromonadaceae,Eubacteriaceae,Enterococcaceae,Erysipelotrichaceae,Flavobacteriaceae,Streptococcaceae,Tannerellaceae,Planococcaceae,Eubacteriales Family XIII. Incertae Sedis,Peptococcaceae,Sphingobacteriaceae,Clostridiales Family XVII. Incertae Sedis,Alcaligenaceae,Peptoniphilaceae,Tenuifilaceae,Enterobacteriaceae,Barnesiellaceae,Burkholderiaceae,Weeksellaceae,Acidaminococcaceae,Streptomycetaceae,Sporomusaceae,Aerococcaceae,Pseudomonadaceae,others\nsample01,22.8,19.46,13.93,9.92,4.0,3.83,3.7,2.93,2.28,2.28,2.0,1.52,1.05,0.95,0.77,0.74,0.41,0.35,0.16,0.15,0.13,0.13,0.07,0.05,0.05,0.05,0.05,0.05,0.04,0.04,0.03,0.03,0.02,0.02,0.02,0.02,0.02,0.02,0.02,0.02,5.890000000000057\nsample02,0.04,38.84,45.38,0.08,0.01,6.49,0.71,0.01,0.77,0.01,2.74,0,0.29,0.14,0.14,0,0,0.4,0.05,0.02,0,0.03,0,0.01,0.13,0.05,0,0,0.06,0,0,0.01,0,0.01,0,0,0.02,0,0,0.02,3.539999999999992\n"

        var O = "library,Eubacteriales,Bacteroidales,Fusobacteriales,Bacillales,Selenomonadales,Veillonellales,Coriobacteriales,Burkholderiales,Lactobacillales,Campylobacterales,Flavobacteriales,Erysipelotrichales,Sphingobacteriales,Enterobacterales,Tissierellales,Streptomycetales,Pseudomonadales,Halanaerobiales,Acidaminococcales,Micrococcales,Thiotrichales,Thermoanaerobacterales,Xanthomonadales,Methylococcales,Hyphomicrobiales,Alteromonadales,Marinilabiliales,Chitinophagales,Cytophagales,Acholeplasmatales,Synechococcales,Oscillatoriales,Corynebacteriales,Sphingomonadales,others\nsample01,41.4,26.19,9.92,6.61,4.03,2.93,2.0,1.6,1.16,0.74,0.15,0.15,0.05,0.04,0.04,0.02,0.02,0.02,0.02,0.02,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01,2.749999999999929\nsample02,94.76,0.05,0.08,1.22,0.01,0.01,2.74,0.07,0.23,0,0,0.02,0,0.03,0,0.02,0.02,0,0,0.03,0.01,0,0.01,0.01,0.01,0.01,0,0,0,0.01,0,0,0.01,0,0.6399999999999721\n"

        var dataset = {};
        dataset["S"] = S;
        dataset["G"] = G;
        dataset["F"] = F;
        dataset["O"] = O;
        
        function loadsamples(f) {
                // columns data0 data1を入力としてcolumnsとkey:valueのobjectを返す
                var data = d3.csvParse(dataset[f], (d, _, columns) => {
                        var total = 100;
                        d.total = total;
                        return d
                });
                var keys = data.columns.slice(1);

                // 
                data.sort(function (a, b) {
                    return b.total - a.total;
                });

                // domain設定（x:サンプル, y:値, z: taxonomy)
                x.domain(data.map(function (d) {
                    return d.library;
                }));
                y.domain([0, d3.max(data, function (d) {
                    return d.total;
                })]).nice();
                z.domain(keys);

                // Barplot
                g.append("g")
                    .selectAll("g")
                    .data(d3.stack().keys(keys)(data))
                    .enter().append("g")
                    .attr("fill", function (d) {
                        if (d.key == "others"){
                            return "#cccccc"
                        }else {
                            return z(d.key); 
                        }
                    })
                    .attr("class", function(d,i){
                        return "n" + (keys.length - i)
                    })
                    .attr("data-name", function(d){
                        return d.key
                    })
                    .selectAll("rect")
                    .data(function (d,i) {
                        // サンプル内のindexをここまで保持する
                        // dは 2サンプル分の(始点,終点,全体のobject) な配列を含む配列
                        // taxonomyをキーにサンプルの持つ値がマトマメラれる
                        return d;
                    })
                    .enter().append("rect")
                    .attr("x", function (d) {
                        // 1サンプル分ずつ処理
                        return x(d.data.library);
                    })
                    .attr("y", function (d) {
                        return y(d[1]);
                    })    //  Errory: expected length, NaN
                    .attr("height", function (d) {
                        return y(d[0]) - y(d[1]);
                    })
                    .attr("width", x.bandwidth())
                    .on("mouseover", function(){
                        d3.selectAll("." + this.parentNode.className.baseVal)
                        .style("stroke-opacity",1)
                        .attr("stroke", "#FE5000")
                        .attr("stroke-width", 3)
                    })
                    .on("mouseout", function(){
                        d3.selectAll("." + this.parentNode.className.baseVal)
                        .style("stroke-opacity", 0)
                    })
                    .on("click", function(d){
                        var taxonomy_name = this.parentNode.getAttribute("data-name")
                        var taxonomy_name = taxonomy_name.replace(/\s+/g,"+")
                        var base_url = "https://www.ncbi.nlm.nih.gov/taxonomy/?term="
                        window.open(base_url + taxonomy_name, "_blank")
                    });

                g.append("g")
                    .attr("class", "axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x).tickSize(10, 15, 10));

                g.append("g")
                    .attr("class", "axis")
                    .call(d3.axisLeft(y).ticks(null, "s"))
                    .append("text")
                    .attr("x", -35)
                    .attr("y", y(y.ticks().pop()) - 15)
                    .attr("dy", "0.32em")
                    .attr("fill", "#000")
                    .attr("font-weight", "bold")
                    .attr("text-anchor", "start")
                    .text("Population");

                // scientific name group
                // keyと順位が渡される
                var legend = g.append("g")
                    .attr("font-family", "sans-serif")
                    .attr("font-size", 12)
                    .attr("text-anchor", "end")
                    .selectAll("g")
                    .data(keys.slice().reverse())
                    .enter().append("g")
                    .attr("transform", function (d, i) {
                        return "translate(275," + (i * 20) + ")"
                    });

                legend.append("rect")
                    .attr("x", width - 19)
                    .attr("width", 19)
                    .attr("height", 19)
                    .attr("fill", z)
                    .attr("class", function(d, i){
                        return ("n" + String(Number(i)+1))
                    })
                    .on("mouseover", function(){
                        d3.selectAll("." + this.className.baseVal)
                        .style("stroke-opacity",1)
                        .attr("stroke", "#FE5000")
                        .attr("stroke-width", 3)
                    })
                    .on("mouseout", function(){
                        d3.selectAll("." + this.className.baseVal)
                        .style("stroke-opacity", 0)
                    })
                    .on("click", function(d){
                        var taxonomy_name = d
                        taxonomy_name = taxonomy_name.replace(/\s+/g,"+")
                        var base_url = "https://www.ncbi.nlm.nih.gov/taxonomy/?term="
                        window.open(base_url + taxonomy_name, "_blank")
                    });

                // scientific name
                legend.append("text")
                    .attr("x", width - 24)
                    .attr("y", 9.5)
                    .attr("dy", "0.32em")
                    .text(function (d) {
                        return d;
                    });

                // rank switch
                var ranks = ["S", "G", "F", "O"]
                var switches = g.append("g")
                    .attr("width", 285)
                    .attr("hight", 50)
                    .attr("class", "switch")
                    .attr("fill", "black")
                    .attr("transform", "translate(300, 820)");

                switches.selectAll("text")
                    .data(ranks)
                    .enter().append("text")
                    .text(function (d) {
                        return d
                    })
                    .attr("font-weight", function (d,i) {
                        if (d == f){return "bolder"} else {return "normal"}
                    })
                    .attr("transform", function (d, i) {
                        return "translate(" + i * 15 + ",0)";
                    })
                    .on("click", function (d) {
                        window.open("./d3.html?rank=" + d, "_self")
                    })
        }
    
        var url = new URL(window.location.href);
        var params = url.searchParams;
        var r = params.get("rank") ? params.get("rank"): "S";
        loadsamples(r)
    
    </script>
    </html>
    
    